# Weekly NASCAR Data Update
#
# This workflow automatically updates NASCAR race data every Monday morning.
# It scrapes new race results from DriverAverages.com, validates data quality,
# and uploads to Cloudflare R2 (the canonical data store).

name: Weekly NASCAR Data Update

on:
  # Schedule: Every Monday at 10:00 UTC (5:00 AM EST)
  schedule:
    - cron: '0 10 * * 1'

  # Allow manual triggering from the Actions tab
  workflow_dispatch:

jobs:
  update-nascar-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: nascar-update
      cancel-in-progress: false

    permissions:
      contents: write

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::arrow
            any::cli
            any::dplyr
            any::glue
            any::httr2
            any::paws.storage
            any::purrr
            any::rvest
            any::stringdist
            any::stringr

      - name: Scrape new races and upload to R2
        run: Rscript inst/updates/run_all_updates.R

      - name: Validate data quality
        run: |
          Rscript -e "
          library(arrow)
          source('inst/validation/validate_data.R')

          cup <- arrow::read_parquet('https://nascar.kylegrealis.com/cup_series.parquet')
          nxs <- arrow::read_parquet('https://nascar.kylegrealis.com/nxs_series.parquet')
          truck <- arrow::read_parquet('https://nascar.kylegrealis.com/truck_series.parquet')

          load('inst/updates/cup_track_info.rda')
          load('inst/updates/nxs_track_info.rda')
          load('inst/updates/truck_track_info.rda')

          validate_series_data(cup, 'cup', cup_track_info)
          validate_series_data(nxs, 'nxs', nxs_track_info)
          validate_series_data(truck, 'truck', truck_track_info)

          message('All data validated successfully!')
          "

      - name: Commit checksums
        run: |
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"

          git add .checksums.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update NASCAR data [automated]"
            git push origin main
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Weekly NASCAR update failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The weekly NASCAR data update workflow failed.\n\nSee: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['automated', 'bug']
            });
